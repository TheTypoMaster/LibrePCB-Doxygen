<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>LibrePCB Developers Documentation: Project Documentation</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../librepcb_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">LibrePCB Developers Documentation
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d5/d75/doc_project.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Project Documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#doc_project_filestructure">The File Structure of a Project</a></li>
<li class="level1"><a href="#doc_project_lock">Avoid opening a project multiple times (File Lock)</a></li>
<li class="level1"><a href="#doc_project_undostack">The undo/redo system (Command Design Pattern)</a></li>
<li class="level1"><a href="#doc_project_compatibility">Compatibility between different application versions</a></li>
<li class="level1"><a href="#doc_project_save">Saving Procedere / Automatic Periodically Saving</a></li>
</ul>
</div>
<div class="textblock"><p>This is the documentation of an LibrePCB project. Such a project is represented by an instance of the class <a class="el" href="../../d2/d05/classproject_1_1_project.html" title="The Project class represents a whole (opened) project with all its content. ">project::Project</a>.</p>
<h1><a class="anchor" id="doc_project_filestructure"></a>
The File Structure of a Project</h1>
<p>See <a class="el" href="../../d8/d06/doc_project_file_structure.html">Project File Structure Documentation</a>.</p>
<h1><a class="anchor" id="doc_project_lock"></a>
Avoid opening a project multiple times (File Lock)</h1>
<p>It's very dangerous if a project is opened multiple times simultaneously. Even if the application's design does not allow to open a project multiple times, it's still possible to save a project in a shared folder and open it from different computers at the same time (for example). This can demage the project files!</p>
<p>To avoid such problems, the Project's constructor will try to lock the project file (*.lpp) with a <a class="el" href="../../d9/d57/class_file_lock.html" title="This class can be used to implement file-based file locks. ">FileLock</a> object (<a class="el" href="../../d2/d05/classproject_1_1_project.html#ac989787d3db780913c9369182198db89" title="See Avoid opening a project multiple times (File Lock). ">project::Project::mFileLock</a>). If the project file is already locked by another application instance, the project cannot be opened (the Project's constructor throws an exception). If the lock file exists because the application was crashed while the project was open, the user gets a message box to ask whether the last automatic backup should be restored or not (see also <a class="el" href="../../d5/d75/doc_project.html#doc_project_save">Saving Procedere / Automatic Periodically Saving</a>). The lock will be released automatically when the <a class="el" href="../../d2/d05/classproject_1_1_project.html" title="The Project class represents a whole (opened) project with all its content. ">project::Project</a> object is destroyed (RAII, see <a class="el" href="../../d9/d57/class_file_lock.html" title="This class can be used to implement file-based file locks. ">FileLock</a> documentation).</p>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="../../d9/d57/class_file_lock.html" title="This class can be used to implement file-based file locks. ">FileLock</a>, <a class="el" href="../../d2/d05/classproject_1_1_project.html#aa1679af445e8bdff6400514e9ca2066b">project::Project::Project()</a>, <a class="el" href="../../d2/d05/classproject_1_1_project.html#ac989787d3db780913c9369182198db89" title="See Avoid opening a project multiple times (File Lock). ">project::Project::mFileLock</a></dd></dl>
<h1><a class="anchor" id="doc_project_undostack"></a>
The undo/redo system (Command Design Pattern)</h1>
<p>It's very important to have an undo and a redo command for the whole project (and maybe also for independent parts of the project). For this purpose we use the "Command Design Pattern". Our common classes <a class="el" href="../../d3/d26/class_undo_command.html" title="The UndoCommand class represents a command which you can undo/redo. ">UndoCommand</a> and <a class="el" href="../../d4/d90/class_undo_stack.html" title="The UndoStack class holds UndoCommand objects and provides undo/redo commands. ">UndoStack</a> implement this design pattern. Look at their documentation for more details.</p>
<dl class="section note"><dt>Note</dt><dd>The documentation "Overview of Qt's Undo Framework" (<a href="http://qt-project.org/doc/qt-5/qundo.html">http://qt-project.org/doc/qt-5/qundo.html</a>) and/or other documentations about the Command Design Pattern may be useful to understand the whole undo/redo system. Our own undo classes are quite similar to Qt's classes QUndoCommand and QUndoStack.</dd></dl>
<p>There is a <a class="el" href="../../d4/d90/class_undo_stack.html" title="The UndoStack class holds UndoCommand objects and provides undo/redo commands. ">UndoStack</a> object for the whole project (project::Project::mUndoStack). All important changes to the project which should appear in the undo stack needs to be implemented as a subclass of <a class="el" href="../../d3/d26/class_undo_command.html" title="The UndoCommand class represents a command which you can undo/redo. ">UndoCommand</a> and must be appended to project::Project::mUndoStack. Changes which do not need an undo action (like changing the color of a layer) can be done without the use of the undo/redo system. These changes then cannot be undone. Basically, all changes to the circuit/schematics/boards and so on must have an undo action! If you are unsure if you should use the project's undo/redo system, try to answer the question "do the user wants to undo/redo this action with the undo/redo buttons in the
    schematic- or board-editor?".</p>
<p>It's possible to use seperate <a class="el" href="../../d4/d90/class_undo_stack.html" title="The UndoStack class holds UndoCommand objects and provides undo/redo commands. ">UndoStack</a> objects for independent parts of the project. For example, changing the project settings could be done by using an undo/redo system to provide an undo command. But these undo stacks need their own undo/redo buttons. The undo/redo buttons in the schematic editor and in the board editor are only connected to the stack project::Project::mUndoStack.</p>
<p><a class="el" href="../../d3/d26/class_undo_command.html" title="The UndoCommand class represents a command which you can undo/redo. ">UndoCommand</a> objects can also have an unlimited amount of child objects. This is very useful to group actions together. For example, if multiple symbols are selected in the schematic and the user wants to remove them all, multiple <a class="el" href="../../d3/d26/class_undo_command.html" title="The UndoCommand class represents a command which you can undo/redo. ">UndoCommand</a> objects will be created (one for each symbol). But if the user now wants to undo the deletion, the undo command (Ctrl+Z) will only bring back the last symbol, so the user needs to press the undo command multiple times. This is not good. So we use the parent/child mechanism of <a class="el" href="../../d3/d26/class_undo_command.html" title="The UndoCommand class represents a command which you can undo/redo. ">UndoCommand</a>. This means, we will still create a <a class="el" href="../../d3/d26/class_undo_command.html" title="The UndoCommand class represents a command which you can undo/redo. ">UndoCommand</a> for each removed symbol. But we will also create a parent <a class="el" href="../../d3/d26/class_undo_command.html" title="The UndoCommand class represents a command which you can undo/redo. ">UndoCommand</a> for all these child commands. Only the parent command will be added to the undo stack (for example project::Project::mUndoStack). Now, if the user wants to undo the deletion, he only needs to press undo (Ctrl+Z) once. And with pressing redo (Ctrl+Y) once, all symbols will be restored.</p>
<dl class="section see"><dt>See Also</dt><dd><a class="el" href="../../d3/d26/class_undo_command.html" title="The UndoCommand class represents a command which you can undo/redo. ">UndoCommand</a>, <a class="el" href="../../d4/d90/class_undo_stack.html" title="The UndoStack class holds UndoCommand objects and provides undo/redo commands. ">UndoStack</a>, project::Project::mUndoStack </dd>
<dd>
<a href="http://qt-project.org/doc/qt-5/qundo.html">http://qt-project.org/doc/qt-5/qundo.html</a> (Overview of Qt's Undo Framework)</dd></dl>
<h1><a class="anchor" id="doc_project_compatibility"></a>
Compatibility between different application versions</h1>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000028">Todo:</a></b></dt><dd></dd></dl>
<p>We need a system to ensure that a project with all its files can be loaded and saved with different application versions without corrupting the project.</p>
<p>For this purpose, the *.lpp XML file of each project has two attributes in the root XML element: "project_version" and "compatible_downto". Both are unsigned integer values, with a minimum value of "1". Zero is invalid.</p>
<p>"project_version" describes the version of all project files. For example, the version "1" is a very old version. <a class="el" href="../../de/d34/class_version.html" title="The Version class represents a version number in the format &quot;1.42.7&quot;. ">Version</a> "2" supports some more features. <a class="el" href="../../de/d34/class_version.html" title="The Version class represents a version number in the format &quot;1.42.7&quot;. ">Version</a> "3" has a new file format, which is not compatible to the older versions. If a project is saved, the value from Project::sProjectFileVersion is written to the "project_version" attribute of the project file.</p>
<p>But if you want to open a very new project with an old application version, the "project_version" attribute of the project can be higher than the value in Project::sProjectFileVersion. This means that the application cannot know if it can open the project or not (if the version is backward-compatible). To avoid this problem, there is an additional attribute in the project's XML files: "compatible_downto". With this value, the XML file can "tell" the application, if it can open the project or not. If "compatible_downto" is less or equal to the application's Project::sProjectFileVersion, the application can open the project, even if the application is older than the new project file format. If a project is saved, the value from Project::sProjectFileCompatibleDowntoVersion is written to the "compatible_downto" attribute of the project file.</p>
<dl class="section see"><dt>See Also</dt><dd>project::Project::mProjectFileVersion, project::Project::mProjectFileCompatibleDowntoVersion, project::Project::sProjectFileVersion, project::Project::sProjectFileCompatibleDowntoVersion</dd></dl>
<h1><a class="anchor" id="doc_project_save"></a>
Saving Procedere / Automatic Periodically Saving</h1>
<p>It's very important to keep all files of a project valid and consistent. If the application crashes, the project files must not be demaged! Also a crash while saving the project should not demage the project (yes, this is difficult...).</p>
<p>Additionally, an automatic backup/restore system is useful to avoid the loose of all the changes made in a project after the last saving. If the application crashes with unsaved changes, it should be possible to restore (some of) these changes while opening that project the next time. To indicate a crash, the <a class="el" href="../../d9/d57/class_file_lock.html" title="This class can be used to implement file-based file locks. ">FileLock</a> class is used (see <a class="el" href="../../d5/d75/doc_project.html#doc_project_lock">Avoid opening a project multiple times (File Lock)</a>)</p>
<p><b>To try to reach these goals, we use temporary copies of the project files while a project is open. This means:</b></p>
<ol type="1">
<li>Each project module which open some files (<a class="el" href="../../d2/d05/classproject_1_1_project.html" title="The Project class represents a whole (opened) project with all its content. ">project::Project</a>, <a class="el" href="../../d1/d03/classproject_1_1_circuit.html" title="The Circuit class represents all electrical connections in a project (drawed in the schematics) ...">project::Circuit</a>, <a class="el" href="../../dd/d2d/classproject_1_1_schematic.html" title="The Schematic class represents one schematic page of a project and is always part of a circuit...">project::Schematic</a> and so on) must copy their needed files to a temporary file (same filepath but with a '~' at the end) before opening them.</li>
<li>Now, NOT the needed files will be opened, but the copied temporary files!</li>
<li>The automatic backup will save all changes to these temporary files.</li>
<li>If the user wants to save the project, all changes will be saved to the temporary files first! Only after ALL changes to the whole project were saved SUCCESSFULLY to these files, the changes can be written to the original files! The temporary files will still exist, do not remove them! If saving to the temporary files was not successful, you mustn't begin saving the changes to the original files! This way, the original files will stay valid even if there is an error in the save algorithm.</li>
<li>On closing a project, all temporary files will be removed from the harddisc.</li>
</ol>
<p>If the application crashes while unsaved changes are made in a project, the temporary files won't be removed (and also the file lock still exist). On opening this project the next time, the user can choose whether to restore the last backup or not. If not, the normal, original files will be loaded (as if there was no crash). But if the backup should be restored, on opening the files the original files must not copied to a backup file, but the backup files must be loaded directly (skip #1 at the list above)! For this purpose, the constructor of classes like <a class="el" href="../../d2/d05/classproject_1_1_project.html" title="The Project class represents a whole (opened) project with all its content. ">project::Project</a>, <a class="el" href="../../d1/d03/classproject_1_1_circuit.html" title="The Circuit class represents all electrical connections in a project (drawed in the schematics) ...">project::Circuit</a> and so on needs a parameter "bool restore" (or similar).</p>
<p><b>Details of #4 of the list above (very important):</b><br/>
 To save a project, all related classes need a method with this signature: </p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> save(<span class="keywordtype">bool</span> toOriginal, QStringList&amp; errors) noexcept; </div>
</div><!-- fragment --><p>This method will be called to save all the changes of the corresponding object <b>and all its child objects</b>. So, the class <a class="el" href="../../d2/d05/classproject_1_1_project.html" title="The Project class represents a whole (opened) project with all its content. ">project::Project</a> provides such a method to save <b>the whole project with all its content</b> (circuit, schematics and so on). If the parameter "toOriginal" is false, all changes will be saved to the temporary files. Otherwise they are saved to the original files. Error messages must be appended the QStringList "errors" (after translation). All entries in the list will be printet out in a message box. The return value is true if the saving proccess was successful, and false if there was an error. These methods should never throw an exception (keyword "noexcept")!</p>
<p>If an error occurs while saving the project, you should not abort the saving proccess. "Save all what you can" is the name of the game :-) Simply add the error message to the error list and return "false" after the job is finished.</p>
<p>The class <a class="el" href="../../d2/d05/classproject_1_1_project.html" title="The Project class represents a whole (opened) project with all its content. ">project::Project</a> also provides the public slot <a class="el" href="../../d2/d05/classproject_1_1_project.html#ace118ad4801f373b6e0691051f917247" title="Save the whole project to the harddisc. ">project::Project::save()</a>. This is the only method you are allowed to call from outside the Project class to save the whole project! This method will try to save the whole project to the temporary files (this-&gt;save(false)). <b>Only if this call has returned "true" (project successful saved to temporary files), it will also save the project to the original files (this-&gt;save(true))!</b></p>
<dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000029">Todo:</a></b></dt><dd>add the ability to show the saving progress in a progress bar</dd></dl>
<p>Each project also contains a QTimer for automatic backups. This timer will call Project::save(false) periodically. So, the project will be saved only to the temporary files, NOT to the original files (because the user did NOT click on the "Save" button). </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">LibrePCB Developers Documentation</a></li>
    <li class="footer">Generated on Wed Jul 22 2015 21:26:11 for LibrePCB Developers Documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
